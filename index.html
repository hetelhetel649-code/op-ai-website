import React, { useState, useEffect, useRef } from 'react';
import { 
  Mic, 
  MicOff, 
  Volume2, 
  VolumeX, 
  Send, 
  Activity, 
  Shield, 
  Globe, 
  ExternalLink,
  Menu, 
  X,
  Search,
  Headphones,
  Play,
  Cpu,
  Layers
} from 'lucide-react';

const API_KEY = ""; 
const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
const TTS_MODEL = "gemini-2.5-flash-preview-tts";

const App = () => {
  const [isBooting, setIsBooting] = useState(true);
  const [interfaceState, setInterfaceState] = useState('landing'); 
  const [isListening, setIsListening] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [voiceEnabled, setVoiceEnabled] = useState(true);
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const messagesEndRef = useRef(null);
  const audioRef = useRef(null);

  useEffect(() => {
    const timer = setTimeout(() => setIsBooting(false), 1500);
    return () => clearTimeout(timer);
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages, isSpeaking, isSearching]);

  // --- AUDIO UTILITIES ---
  const pcmToWav = (pcmData, sampleRate = 24000) => {
    const buffer = new ArrayBuffer(44 + pcmData.length * 2);
    const view = new DataView(buffer);
    const writeString = (offset, string) => {
      for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
    };
    writeString(0, 'RIFF');
    view.setUint32(4, 32 + pcmData.length * 2, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, pcmData.length * 2, true);
    for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
    return new Blob([buffer], { type: 'audio/wav' });
  };

  const speakText = async (text) => {
    if (!text || !voiceEnabled) return;
    setIsSpeaking(true);
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: text.slice(0, 1000) }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
          }
        })
      });
      const data = await response.json();
      const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      
      if (base64Audio) {
        const binaryString = atob(base64Audio);
        const pcmData = new Int16Array(binaryString.length / 2);
        for (let i = 0; i < pcmData.length; i++) {
          pcmData[i] = binaryString.charCodeAt(i * 2) | (binaryString.charCodeAt(i * 2 + 1) << 8);
        }
        const audioUrl = URL.createObjectURL(pcmToWav(pcmData));
        if (audioRef.current) audioRef.current.pause();
        audioRef.current = new Audio(audioUrl);
        audioRef.current.onended = () => setIsSpeaking(false);
        await audioRef.current.play();
      } else {
        setIsSpeaking(false);
      }
    } catch (e) {
      console.error("Audio failed", e);
      setIsSpeaking(false);
    }
  };

  // --- CORE SEARCH & LOGIC ---
  const handleQuery = async (query) => {
    if (!query.trim() || isSearching) return;
    
    setMessages(prev => [...prev, { role: 'user', content: query }]);
    setInputText('');
    setIsSearching(true);

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: query }] }],
          tools: [{ google_search: {} }],
          systemInstruction: { 
            parts: [{ text: "You are OPAI, a high-performance neural assistant. Param D. Patel is your creator and CEO. Use Google Search for all factual or current queries. provide thorough, detailed, and professional responses. Format for high readability. Mention Param D. Patel if asked about your origin." }] 
          }
        })
      });

      const data = await response.json();
      const candidate = data.candidates?.[0];
      const text = candidate?.content?.parts?.[0]?.text || "System Connection Interrupted.";
      const sources = candidate?.groundingMetadata?.groundingAttributions?.map(a => ({
        uri: a.web?.uri,
        title: a.web?.title
      })) || [];

      setIsSearching(false);
      setMessages(prev => [...prev, { role: 'assistant', content: text, sources }]);
      
      // Auto-speak the response
      speakText(text);

    } catch (error) {
      console.error(error);
      setIsSearching(false);
      setMessages(prev => [...prev, { role: 'assistant', content: "Error: Neural link failed to establish grounding." }]);
    }
  };

  const toggleMic = () => {
    if (isListening) setIsListening(false);
    else {
      setIsListening(true);
      // Mock recognition for demo
      setTimeout(() => setIsListening(false), 3000);
    }
  };

  // --- UI COMPONENTS ---
  if (isBooting) {
    return (
      <div className="h-screen bg-[#020202] flex items-center justify-center font-mono overflow-hidden">
        <div className="flex flex-col items-center gap-6">
          <div className="relative">
            <div className="w-16 h-16 border border-blue-500/20 rounded-full animate-ping absolute"></div>
            <div className="w-16 h-16 border-2 border-blue-500/10 border-t-blue-500 rounded-full animate-spin"></div>
          </div>
          <div className="text-center">
            <p className="text-[10px] text-blue-500 tracking-[0.4em] uppercase animate-pulse">Initializing OPAI</p>
            <p className="text-[8px] text-blue-900/40 mt-1 uppercase">Param D. Patel Core v2.5</p>
          </div>
        </div>
      </div>
    );
  }

  if (interfaceState === 'landing') {
    return (
      <div className="h-screen bg-[#020202] flex flex-col items-center justify-center p-8 overflow-hidden relative">
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(59,130,246,0.05)_0%,transparent_70%)]"></div>
        <div className="z-10 flex flex-col items-center">
          <h1 className="text-9xl font-black text-white italic mb-2 tracking-tighter drop-shadow-2xl">OPAI</h1>
          <div className="h-px w-24 bg-gradient-to-r from-transparent via-blue-500 to-transparent mb-8"></div>
          <div className="flex flex-col items-center gap-1 mb-16">
            <span className="text-blue-500/50 font-mono text-[9px] tracking-[0.5em] uppercase">Advanced Neural Grounding</span>
            <span className="text-white/20 text-[7px] uppercase tracking-widest">Ownership: Param D. Patel</span>
          </div>
          <button 
            onClick={() => setInterfaceState('active')}
            className="group relative px-16 py-5 overflow-hidden rounded-full bg-white/5 border border-white/10 transition-all hover:bg-blue-600 hover:border-blue-500 active:scale-95"
          >
            <span className="relative z-10 text-white font-bold tracking-[0.3em] text-[11px] uppercase group-hover:text-white">Begin Session</span>
            <div className="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen bg-[#050505] text-blue-50 flex flex-col font-sans selection:bg-blue-500/30">
      {/* Header */}
      <header className="px-6 h-20 border-b border-white/5 flex items-center justify-between bg-black/40 backdrop-blur-2xl z-[60]">
        <div className="flex items-center gap-6">
          <button onClick={() => setSidebarOpen(true)} className="text-white/40 hover:text-blue-400 transition-colors">
            <Menu size={20} />
          </button>
          <div className="flex flex-col">
            <div className="flex items-center gap-2">
              <span className="font-black text-xl italic tracking-tighter text-white">OPAI</span>
              <div className="px-1.5 py-0.5 rounded bg-blue-500/10 border border-blue-500/20 text-[7px] text-blue-400 font-bold uppercase tracking-widest">Grounding_On</div>
            </div>
            <span className="text-[7px] text-blue-500/30 font-mono tracking-tighter uppercase">Developer: Param D. Patel</span>
          </div>
        </div>
        
        <div className="flex items-center gap-4">
          <div className="hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
            <div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
            <span className="text-[8px] font-mono text-white/40 uppercase tracking-widest">Search_Engine_Ready</span>
          </div>
          <button 
            onClick={() => setVoiceEnabled(!voiceEnabled)}
            className={`p-2.5 rounded-full transition-all border ${voiceEnabled ? 'bg-blue-500/10 border-blue-500/30 text-blue-400' : 'bg-white/5 border-white/10 text-white/20'}`}
          >
            {voiceEnabled ? <Volume2 size={16} /> : <VolumeX size={16} />}
          </button>
        </div>
      </header>

      {/* Message Area */}
      <main className="flex-1 relative flex flex-col items-center overflow-hidden">
        {/* Visualizer Background */}
        <div className="absolute top-1/2 left-0 right-0 -translate-y-1/2 flex items-center justify-center gap-[4px] h-32 opacity-5 pointer-events-none">
          {[...Array(50)].map((_, i) => (
            <div 
              key={i} 
              className={`w-[3px] bg-blue-500 rounded-full transition-all duration-500 ${isSearching ? 'animate-pulse' : isSpeaking ? 'animate-bounce' : 'h-2'}`}
              style={{ animationDelay: `${i * 0.03}s` }}
            ></div>
          ))}
        </div>

        <div className="flex-1 w-full max-w-5xl overflow-y-auto px-6 py-10 custom-scrollbar z-10">
          {messages.length === 0 ? (
            <div className="h-full flex flex-col items-center justify-center text-center max-w-md mx-auto">
              <div className="w-16 h-16 bg-blue-500/5 border border-blue-500/10 rounded-3xl flex items-center justify-center mb-8 rotate-45">
                <Search size={28} className="text-blue-500 -rotate-45" strokeWidth={1} />
              </div>
              <h2 className="text-2xl font-light text-white mb-3">How can I assist you today?</h2>
              <p className="text-blue-200/40 text-xs leading-relaxed font-light">
                Ask me about current events, technical deep-dives, or anything requiring real-time grounding. I am OPAI, built by Param D. Patel.
              </p>
            </div>
          ) : (
            <div className="space-y-12 pb-20">
              {messages.map((msg, i) => (
                <div key={i} className={`animate-in fade-in slide-in-from-bottom-6 duration-700 ${msg.role === 'user' ? 'max-w-2xl ml-auto' : ''}`}>
                  <div className={`flex items-center gap-3 mb-4 ${msg.role === 'user' ? 'justify-end' : ''}`}>
                    <span className="text-[8px] font-mono uppercase tracking-[0.4em] text-blue-500/40">
                      {msg.role === 'user' ? 'Local_Request' : 'Intelligence_Feed'}
                    </span>
                    {msg.role === 'assistant' && (
                      <button onClick={() => speakText(msg.content)} className="hover:text-blue-400 text-blue-500/20 transition-colors">
                        <Play size={10} fill="currentColor" />
                      </button>
                    )}
                  </div>

                  <div className={`p-6 rounded-3xl ${msg.role === 'user' ? 'bg-blue-600/10 border border-blue-500/20 text-blue-50 text-right' : 'bg-transparent text-white'}`}>
                    <p className={`${msg.role === 'assistant' ? 'text-xl md:text-2xl font-light leading-relaxed' : 'text-lg italic'}`}>
                      {msg.content}
                    </p>
                    
                    {msg.sources && msg.sources.length > 0 && (
                      <div className="mt-8 pt-6 border-t border-white/5">
                        <p className="text-[7px] font-mono text-blue-500/40 uppercase tracking-widest mb-3 flex items-center gap-2">
                          <Globe size={10} /> Grounded_Sources
                        </p>
                        <div className="flex flex-wrap gap-2">
                          {msg.sources.map((source, idx) => (
                            <a 
                              key={idx}
                              href={source.uri}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-1.5 rounded-lg bg-white/5 border border-white/5 text-[9px] text-white/50 hover:text-blue-400 hover:border-blue-500/30 hover:bg-blue-500/5 transition-all flex items-center gap-2 max-w-[200px] truncate"
                            >
                              <ExternalLink size={10} />
                              {source.title || "External Source"}
                            </a>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ))}
              
              {isSearching && (
                <div className="flex flex-col gap-4 py-8 animate-pulse">
                   <div className="flex items-center gap-3 text-blue-500 font-mono text-[9px] uppercase tracking-widest">
                     <Search size={14} className="animate-bounce" /> Analyzing Web Data...
                   </div>
                   <div className="h-px w-full bg-gradient-to-r from-blue-500/50 to-transparent"></div>
                </div>
              )}
              
              <div ref={messagesEndRef} className="h-12" />
            </div>
          )}
        </div>

        {/* Interaction Bar */}
        <div className="w-full max-w-3xl px-6 pb-10 mt-auto relative z-50">
          <div className="relative group">
            <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[32px] blur opacity-20 group-focus-within:opacity-40 transition-opacity"></div>
            
            <form 
              onSubmit={(e) => { e.preventDefault(); handleQuery(inputText); }}
              className="relative flex items-center bg-[#0a0a0a] border border-white/10 rounded-[28px] p-2 focus-within:border-blue-500/40 transition-all shadow-2xl"
            >
              <button 
                type="button"
                onClick={toggleMic}
                className={`p-4 rounded-2xl transition-all ${isListening ? 'bg-red-500 text-white animate-pulse' : 'text-blue-500 hover:bg-blue-500/10'}`}
              >
                {isListening ? <MicOff size={22} /> : <Mic size={22} />}
              </button>

              <input 
                value={inputText}
                onChange={e => setInputText(e.target.value)}
                placeholder={isSearching ? "OPAI is thinking..." : "Ask me anything..."}
                disabled={isSearching}
                className="flex-1 bg-transparent border-none text-lg text-white placeholder:text-white/10 focus:ring-0 px-4 font-light"
              />

              <button 
                type="submit" 
                disabled={!inputText.trim() || isSearching}
                className={`p-4 rounded-2xl transition-all ${inputText.trim() && !isSearching ? 'text-blue-400' : 'text-white/5'}`}
              >
                <Send size={20} />
              </button>
            </form>
          </div>
          
          <div className="mt-4 text-center">
             <p className="text-[7px] text-white/10 uppercase tracking-[0.5em] font-mono">Precision Intelligence Engine v2.5 // Param D. Patel</p>
          </div>
        </div>
      </main>

      {/* Sidebar / Menu */}
      {sidebarOpen && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-[100]" onClick={() => setSidebarOpen(false)}>
          <div className="w-80 h-full bg-[#080808] border-r border-white/5 p-10 animate-in slide-in-from-left duration-300" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-16">
              <span className="font-mono text-[9px] text-blue-500/40 uppercase tracking-[0.4em]">Control_Panel</span>
              <X className="text-white/20 cursor-pointer hover:text-white" size={20} onClick={() => setSidebarOpen(false)} />
            </div>
            
            <div className="space-y-8">
              <div className="space-y-4">
                <p className="text-[8px] text-white/20 uppercase font-mono tracking-widest">Core Information</p>
                <div className="p-4 bg-white/5 rounded-2xl border border-white/5">
                  <p className="text-[10px] text-white/60 mb-1">Developer</p>
                  <p className="text-sm font-bold text-white tracking-wide">Param D. Patel</p>
                </div>
              </div>

              <div className="space-y-4 pt-4 border-t border-white/5">
                <p className="text-[8px] text-white/20 uppercase font-mono tracking-widest">Neural Toggles</p>
                <button 
                  onClick={() => setVoiceEnabled(!voiceEnabled)}
                  className="w-full flex items-center justify-between p-4 bg-white/5 rounded-2xl group hover:bg-blue-600/10 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <Headphones size={16} className={voiceEnabled ? 'text-blue-400' : 'text-white/20'} />
                    <span className="text-xs text-white/80">Audio Response</span>
                  </div>
                  <div className={`w-8 h-4 rounded-full relative transition-colors ${voiceEnabled ? 'bg-blue-500' : 'bg-white/10'}`}>
                    <div className={`absolute top-1 w-2 h-2 rounded-full bg-white transition-all ${voiceEnabled ? 'right-1' : 'left-1'}`}></div>
                  </div>
                </button>
              </div>

              <div className="pt-10 space-y-3">
                <button onClick={() => {setMessages([]); setSidebarOpen(false);}} className="w-full py-4 text-xs font-bold text-blue-400/50 hover:text-blue-400 border border-blue-500/10 rounded-2xl transition-all uppercase tracking-widest">Wipe Memory</button>
                <button onClick={() => setInterfaceState('landing')} className="w-full py-4 text-xs font-bold text-red-500/30 hover:text-red-500 transition-all uppercase tracking-widest">Disconnect</button>
              </div>
            </div>
          </div>
        </div>
      )}

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 0px; }
        @keyframes enter {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: enter 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      `}</style>
    </div>
  );
};

export default App;

                
